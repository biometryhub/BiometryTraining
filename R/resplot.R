#' Residual plots of linear models.
#'
#' Produces plots of residuals for assumption checking of linear (mixed) model.
#'
#' @param mod.obj An `aov`, `lm`, `lme` ([nlme::lme()]), `lmerMod` ([lme4::lmer()]), `asreml` or `mmer` (sommer) model object.
#' @param shapiro (Logical) Display the Shapiro-Wilks test of normality on the plot?
#' @param axes.size A numeric value for the size of the axes label font size in points.
#' @param label.size A numeric value for the size of the label (A,B,C) font point size.
#'
#' @return A list containing ggplot2 objects which are diagnostic plots.
#'
#' @importFrom ggplot2 ggplot geom_histogram aes theme_bw stat_qq labs geom_qq_line geom_point
#' @importFrom stats fitted qnorm quantile residuals sd shapiro.test
#' @importFrom cowplot plot_grid add_sub
#'
#' @aliases resplt
#'
#' @examples
#' dat.aov <- aov(Petal.Length ~ Petal.Width, data = iris)
#' resplot(dat.aov)
#' resplt(dat.aov)
#' @export

resplot <- function(mod.obj, shapiro = TRUE, label.size = 10, axes.size = 10){

    # Assign NULL to variables that give a NOTE in package checks
    # Known issue. See https://www.r-bloggers.com/no-visible-binding-for-global-variable/

    stdres <- NULL
    # resids <- NULL

    if (inherits(mod.obj, c("aov", "lm", "lmerMod", "lme", "lmerModLmerTest"))) {
        facet <- 1
        facet_name <- NULL
        resids <- residuals(mod.obj)
        k <- length(resids)
        fits <- fitted(mod.obj)
    }
    else if (inherits(mod.obj, "asreml")){
        facet <- length(names(mod.obj$R.param))
        if (facet > 1) {
            facet_name <- names(mod.obj$R.param)
            k <- unlist(lapply(1:facet, function(i) mod.obj$R.param[[i]]$variance$size))
        }
        else {
            facet_name <- NULL
            k <- length(mod.obj$residual)
        }
        resids <- residuals(mod.obj)
        fits <- fitted(mod.obj)
    }
    else if(inherits(mod.obj, "mmer")) {
        facet <- mod.obj$termsN$rcov
        facet_name <- NULL
        k <- length(mod.obj$residual)

        resids <- residuals(mod.obj)[,ncol(residuals(mod.obj))]
        fits <- fitted(mod.obj)$dataWithFitted[,paste0(mod.obj$terms$response[[1]], ".fitted")]
    }
    else {
        stop("mod.obj must be an aov, lm, lmerMod, lmerModLmerTest, asreml or mmer object")
    }

    aa <- data.frame(residuals = resids, fitted = fits, lvl = rep(1:facet, k))

    output <- list()

    for (i in 1:facet){

        aa.f <- aa[aa$lvl==i,]
        aa.f$stdres <- aa.f$residuals/(sd(aa.f$residuals, na.rm = TRUE)*sqrt((length(!is.na(aa.f$residuals)-1))/(length(!is.na(aa.f$residuals)))))

        a <- ggplot2::ggplot(data = aa.f, mapping = ggplot2::aes(x = stdres)) +
            ggplot2::geom_histogram(bins = ifelse(nrow(aa) < 31, 7, 11), fill = "aquamarine3", colour = "black") +
            ggplot2::theme_bw(base_size = axes.size) + ggplot2::labs(y = "Frequency", x = "Standardised Residual")

        b <- ggplot2::ggplot(aa.f, ggplot2::aes(sample = stdres)) + ggplot2::geom_qq(colour = "black", fill = "aquamarine3", size = 2 , shape = 21) +
            ggplot2::geom_qq_line() + ggplot2::theme_bw(base_size = axes.size) +
            ggplot2::labs(y = "Standardised Residual", x = "Theoretical")

        c <- ggplot2::ggplot(data = aa.f, mapping = ggplot2::aes(x = fitted, y = stdres)) +
            ggplot2::geom_point(colour = "black", fill = "aquamarine3", size = 2 , shape = 21) + ggplot2::theme_bw(base_size = axes.size) +
            ggplot2::labs(y = "Standardised Residual", x = "Fitted Value")

        top_row <- cowplot::plot_grid(a, b, ncol=2, labels = c("A", "B"), label_size = label.size)

        if(shapiro) {
            shap <- shapiro.test(aa.f$residuals)

            shapiro_text <- c(paste(shap$method, "p-value:", round(shap$p.value, 4)),
                              ifelse(shap$p.value>0.05,
                                     paste0("The residuals appear to be normally distributed. (n = ", length(aa.f$residuals), ")"),
                                     paste0("The residuals do not appear to be normally distributed. (n = ", length(aa.f$residuals), ")")))

            bottom_row <- cowplot::plot_grid(NULL, cowplot::add_sub(cowplot::add_sub(c, shapiro_text[1], size = 11, vjust = 1.2),
                                                                    shapiro_text[2], size = 9, vjust = 0.2), NULL,
                                             ncol=3, rel_widths=c(0.25,0.5,0.25), labels = c("", "C", ""),
                                             label_size = label.size, hjust = 1)
        }
        else{
            bottom_row <- cowplot::plot_grid(NULL, c, NULL, ncol=3, rel_widths=c(0.25,0.5,0.25), labels = c("", "C", ""), hjust = 1, label_size = label.size)
        }
        output[[i]] <- cowplot::plot_grid(top_row, bottom_row, ncol=1)
    }

    if(facet>1) {
        names(output) <- facet_name
        return(output)
    }
    else {
        return(output[[1]])
    }
}

#' @rdname resplot
#' @export
resplt <- resplot
